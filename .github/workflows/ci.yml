name: CI (integration)

on:
  push:
  pull_request:
  schedule:
    - cron: '15 4 * * *'
  repository_dispatch:
    types: [workflow-release]
  workflow_dispatch:
    inputs:
      workflow_ref:
        description: 'Workflow ref to test (e.g., @main, @v1, @v1.2.3)'
        required: false
        default: '@main'

jobs:
  # Configuration 1: Basic - minimal settings, single Python version
  basic:
    name: Basic (3.12 only)
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@main
    with:
      python-versions: '["3.12"]'
      coverage: false
      lint: true
      format_check: true
      typecheck: false
      enable-metrics: false
      enable-history: false
      enable-coverage-delta: false
      enable-soft-gate: false
      artifact-prefix: basic-
    secrets: inherit

  # Configuration 2: Full coverage - all features enabled
  full-coverage:
    name: Full coverage (3.11, 3.12)
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@main
    with:
      python-versions: '["3.11", "3.12"]'
      coverage: true
      lint: true
      format_check: true
      typecheck: true
      run-mypy: true
      enable-metrics: false
      enable-history: false
      enable-coverage-delta: false
      enable-soft-gate: false
      baseline-coverage: '80'
      coverage-alert-drop: '2'
      artifact-prefix: full-
    secrets: inherit

  # Configuration 3: Typecheck only - focused mypy validation
  typecheck-only:
    name: Typecheck only (3.11)
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@main
    with:
      python-versions: '["3.11"]'
      coverage: false
      lint: false
      format_check: false
      typecheck: true
      run-mypy: true
      enable-metrics: false
      enable-history: false
      enable-coverage-delta: false
      enable-soft-gate: false
      artifact-prefix: typecheck-
    secrets: inherit

  # Configuration 4: Lint only - no tests, just code quality
  lint-only:
    name: Lint only (3.12)
    uses: stranske/Workflows/.github/workflows/reusable-10-ci-python.yml@main
    with:
      python-versions: '["3.12"]'
      coverage: false
      lint: true
      format_check: true
      typecheck: false
      enable-metrics: false
      enable-history: false
      enable-coverage-delta: false
      enable-soft-gate: false
      artifact-prefix: lint-
    secrets: inherit

  notify-failure:
    name: Report failure to Workflows
    needs: [basic, full-coverage, typecheck-only, lint-only]
    if: ${{ failure() && github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Open issue in Workflows repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTIONS_BOT_PAT }}
          script: |
            const title = `ðŸ”´ Integration CI failed (run ${context.runNumber})`;
            const body = [
              `## Integration Test Failure`,
              ``,
              `The [Workflows-Integration-Tests](https://github.com/${context.repo.owner}/Workflows-Integration-Tests) CI failed.`,
              ``,
              `| Field | Value |`,
              `|-------|-------|`,
              `| **Run ID** | [${context.runId}](https://github.com/${context.repo.owner}/Workflows-Integration-Tests/actions/runs/${context.runId}) |`,
              `| **Trigger** | \`${context.eventName}\` |`,
              `| **Branch** | \`${context.ref.replace('refs/heads/', '')}\` |`,
              `| **Commit** | [\`${context.sha.slice(0, 7)}\`](https://github.com/${context.repo.owner}/Workflows-Integration-Tests/commit/${context.sha}) |`,
              ``,
              `### Next Steps`,
              `1. Check the [failed run logs](https://github.com/${context.repo.owner}/Workflows-Integration-Tests/actions/runs/${context.runId})`,
              `2. Identify if the failure is in the reusable workflow or the integration harness`,
              `3. Fix and close this issue`,
            ].join('\n');

            // Check for existing open issue to avoid duplicates
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: 'stranske',
              repo: 'Workflows',
              state: 'open',
              labels: 'integration-failure',
              per_page: 5
            });

            if (issues.length > 0) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: 'stranske',
                repo: 'Workflows',
                issue_number: issues[0].number,
                body: `Another failure detected:\n\n${body}`
              });
              console.log(`Added comment to existing issue #${issues[0].number}`);
            } else {
              // Create new issue
              const { data: issue } = await github.rest.issues.create({
                owner: 'stranske',
                repo: 'Workflows',
                title,
                body,
                labels: ['integration-failure', 'bug']
              });
              console.log(`Created issue #${issue.number}`);
            }
