name: Notify Workflows on Change

# Trigger repository_dispatch in Workflows repo when Integration-Tests config changes
# This ensures bidirectional sync - changes here trigger template validation there

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/ci.yml'
      - '.github/workflows/autofix-versions.env'
      - 'pyproject.toml'
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/ci.yml'
      - '.github/workflows/autofix-versions.env'
      - 'pyproject.toml'

permissions:
  contents: read

jobs:
  notify:
    name: Notify Workflows repo
    runs-on: ubuntu-latest
    # Only notify on push to main (not PRs) to avoid noise
    if: github.event_name == 'push'
    steps:
      - name: Checkout retry helpers (Workflows)
        if: ${{ secrets.ACTIONS_BOT_PAT != '' }}
        uses: actions/checkout@v6
        with:
          repository: stranske/Workflows
          path: workflows
          fetch-depth: 1
          sparse-checkout: |
            .github/actions/setup-api-client
            .github/scripts/github-api-with-retry.js
            .github/scripts/token_load_balancer.js
          sparse-checkout-cone-mode: false

      - name: Setup API client
        if: ${{ secrets.ACTIONS_BOT_PAT != '' }}
        uses: ./workflows/.github/actions/setup-api-client
        with:
          secrets: ${{ toJSON(secrets) }}
          github_token: ${{ github.token }}

      - name: Trigger sync check in Workflows
        if: ${{ secrets.ACTIONS_BOT_PAT != '' }}
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ACTIONS_BOT_PAT }}
          script: |
            const { createTokenAwareRetry } = require(
              './workflows/.github/scripts/github-api-with-retry.js'
            );
            const { withRetry } = await createTokenAwareRetry({
              github,
              core,
              env: process.env,
              task: 'integration-notify',
            });

            await withRetry(() => github.rest.repos.createDispatchEvent({
              owner: 'stranske',
              repo: 'Workflows',
              event_type: 'integration-config-changed',
              client_payload: {
                source: 'Workflows-Integration-Tests',
                commit: context.sha,
                ref: context.ref,
              },
            }));

      - name: Skip notification (missing token)
        if: ${{ secrets.ACTIONS_BOT_PAT == '' }}
        run: |
          echo "::warning::ACTIONS_BOT_PAT not available, skipping notification"

  validate-against-template:
    name: Validate against template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v6
        with:
          path: integration-tests

      - name: Clone Workflows repo templates
        uses: actions/checkout@v6
        with:
          repository: stranske/Workflows
          path: workflows
          fetch-depth: 1
          sparse-checkout: |
            templates/integration-repo
          sparse-checkout-cone-mode: false

      - name: Validate CI workflow inputs
        run: |
          set -euo pipefail

          ACTUAL="integration-tests/.github/workflows/ci.yml"

          echo "## CI Workflow Validation" >> "$GITHUB_STEP_SUMMARY"

          # Validate no invalid input names are used
          invalid=""

          # These are common mistakes - using wrong input names
          if grep -qE "^\s+enable-mypy:" "$ACTUAL"; then
            invalid="$invalid enable-mypy"
          fi
          if grep -qE "^\s+enable-coverage:" "$ACTUAL"; then
            invalid="$invalid enable-coverage"
          fi
          if grep -qE "^\s+coverage-threshold:" "$ACTUAL"; then
            invalid="$invalid coverage-threshold"
          fi

          if [ -n "$invalid" ]; then
            echo "::error::Invalid workflow inputs found:$invalid"
            echo "❌ Invalid inputs:$invalid" >> "$GITHUB_STEP_SUMMARY"
            echo ""
            echo "Use these instead:" >> "$GITHUB_STEP_SUMMARY"
            echo "- enable-mypy → typecheck" >> "$GITHUB_STEP_SUMMARY"
            echo "- enable-coverage → coverage" >> "$GITHUB_STEP_SUMMARY"
            echo "- coverage-threshold → coverage-min" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "✅ All workflow inputs are valid" >> "$GITHUB_STEP_SUMMARY"

      - name: Validate artifact-prefix on all jobs
        run: |
          set -euo pipefail

          ACTUAL="integration-tests/.github/workflows/ci.yml"

          echo "## Artifact Prefix Validation" >> "$GITHUB_STEP_SUMMARY"

          # Count jobs using reusable workflow
          job_count=$(grep -c "uses:.*reusable-10-ci-python" "$ACTUAL" || printf '0')
          prefix_count=$(grep -c "artifact-prefix:" "$ACTUAL" || printf '0')

          if [ "$job_count" -gt 1 ] && [ "$prefix_count" -lt "$job_count" ]; then
            echo "::error::Multi-job CI requires artifact-prefix on each job"
            echo "❌ Missing artifact-prefix on some jobs" >> "$GITHUB_STEP_SUMMARY"
            echo "($prefix_count/$job_count)" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "✅ Artifact prefixes configured correctly" >> "$GITHUB_STEP_SUMMARY"

      - name: Compare version pins
        run: |
          set -euo pipefail

          CANONICAL="workflows/templates/integration-repo/.github/workflows/autofix-versions.env"
          ACTUAL="integration-tests/.github/workflows/autofix-versions.env"

          echo "## Version Pins Status" >> "$GITHUB_STEP_SUMMARY"

          # Just warn on version differences, don't fail (repos may intentionally differ)
          for key in BLACK_VERSION RUFF_VERSION MYPY_VERSION PYTEST_VERSION; do
            canonical=$(grep "^${key}=" "$CANONICAL" 2>/dev/null | cut -d= -f2 || echo "")
            actual=$(grep "^${key}=" "$ACTUAL" 2>/dev/null | cut -d= -f2 || echo "")

            if [ -n "$canonical" ] && [ -n "$actual" ] && [ "$canonical" != "$actual" ]; then
              echo "::notice::$key differs: template=$canonical, actual=$actual"
              echo "⚠️ $key: $actual (template: $canonical)" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

          echo "Version comparison complete" >> "$GITHUB_STEP_SUMMARY"
